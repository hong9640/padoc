pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'padoc'
        CONTAINER_NAME = 'padoc-container'
        PORT = '3000'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘...'
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'ğŸ“‹ í™˜ê²½ ì„¤ì • ì¤‘...'
                sh '''
                    if [ ! -f .env ]; then
                        echo "NEXT_PUBLIC_BE_API_URL=${NEXT_PUBLIC_BE_API_URL}" > .env
                    fi
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...'
                sh 'npm ci'
            }
        }
        
        stage('Cleanup Containers') {
            steps {
                echo 'ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘...'
                sh '''
                    docker stop ${CONTAINER_NAME} 2>/dev/null || true
                    docker rm ${CONTAINER_NAME} 2>/dev/null || true
                    docker system prune -f
                '''
            }
        }
        
        stage('Build Application') {
            steps {
                echo 'ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
                sh 'npm run build'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                sh 'docker build -t ${DOCKER_IMAGE} .'
            }
        }
        
        stage('Deploy Container') {
            steps {
                echo 'ğŸš€ ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘...'
                sh 'docker run -d -p ${PORT}:${PORT} --name ${CONTAINER_NAME} ${DOCKER_IMAGE}'
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘...'
                script {
                    def retries = 30
                    def waitTime = 2
                    
                    for (int i = 0; i < retries; i++) {
                        try {
                            sh 'curl -f http://localhost:${PORT}'
                            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤."
                            break
                        } catch (Exception e) {
                            if (i == retries - 1) {
                                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                                sh 'docker logs ${CONTAINER_NAME}'
                                error "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                            }
                            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... (${i+1}/${retries})"
                            sleep waitTime
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ“Š ë°°í¬ ì™„ë£Œ!'
            echo 'ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://localhost:${PORT}'
        }
        failure {
            echo 'âŒ ë°°í¬ ì‹¤íŒ¨!'
            sh 'docker logs ${CONTAINER_NAME}'
        }
    }
}
